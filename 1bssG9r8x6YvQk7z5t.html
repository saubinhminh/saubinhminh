<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>BÁO CÁO SỔ SÁCH</title>
  <style>
    :root{
      --accent:#ff4d4f; --bg:rgba(0,0,0,.5); --card:rgba(255,255,255,.08); --text:#fff; --shadow:0 6px 20px rgba(0,0,0,.35); --active:rgba(255,255,255,.18);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{font-family:system-ui,Arial,sans-serif;margin:0;color:var(--text);background:#0a0a0a url('NenVuTru.png') no-repeat center center fixed;background-size:cover;display:flex;flex-direction:column}

    .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(0deg,rgba(0,0,0,.2),rgba(0,0,0,.7));backdrop-filter:blur(8px);padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .brand{display:flex;align-items:center;justify-content:center}
    .brand h1{font-size:18px;margin:0;text-shadow:1px 1px 2px #000}

    .controls{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .control{background:var(--bg);border-radius:14px;padding:10px;box-shadow:var(--shadow)}
    label{font-size:12px;opacity:.9;display:block;margin-bottom:4px}
    select,input[type="date"],button.btn{width:100%;font-size:16px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:var(--text)}
    button.btn{cursor:pointer}
    button.btn[disabled]{opacity:.6;cursor:not-allowed}

    #pdfContainer{padding:8px 12px 20px}
    .icons{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .pdf-icon{width:100%;cursor:pointer;transition:transform .15s ease}
    .pdf-icon:active{transform:scale(.97)}
    .pdf-icon img{width:100%;height:auto;border-radius:16px;box-shadow:var(--shadow)}

    .skeleton{position:relative;overflow:hidden;border-radius:16px;height:70px;background:rgba(255,255,255,.08)}
    .skeleton:after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);animation:shimmer 1.3s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    .hint{font-size:13px;opacity:.95;margin-top:6px}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);font-size:14px;z-index:9999;opacity:0;pointer-events:none;transition:opacity .25s ease}
    .toast.show{opacity:1}

    .adjacent{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    @media (max-width:460px){ .controls{grid-template-columns:1fr} .icons{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><h1>BÁO CÁO SỔ SÁCH</h1></div>

    <div class="controls">
      <div class="control">
        <label for="repoSelect">Chọn cơ sở</label>
        <select id="repoSelect">
          <option value="SBM1">SBM1</option>
          <option value="SBM2">SBM2</option>
          <option value="SBM3">SBM3</option>
        </select>
      </div>
      <div class="control" id="dateGroup">
        <label id="dateLabel" for="datePicker">Chọn ngày</label>
        <input type="date" id="datePicker" />
        <div class="hint" id="dateHint">&nbsp;</div>

        <!-- Nút tìm ngày có file liền kề -->
        <div class="adjacent">
          <button class="btn" id="prevAvail">◀️ Ngày trước (có file)</button>
          <button class="btn" id="nextAvail">Ngày sau (có file) ▶️</button>
        </div>
      </div>
    </div>
  </div>

  <div id="pdfContainer">
    <div class="icons" id="icons"></div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
  // ===== REPO MAPPING =====
  window.REPOS = {
    SBM1: 'https://raw.githubusercontent.com/saubinhminh/1ILIILIIXIILI/main/',
    SBM2: 'https://raw.githubusercontent.com/saubinhminh/2ILIILIIXIILI/main/',
    SBM3: 'https://raw.githubusercontent.com/saubinhminh/3ILIILIIXIILI/main/'
  };
  // lấy số tiền tố theo cơ sở
  const REPO_NUM = { SBM1:'1', SBM2:'2', SBM3:'3' };
  // tạo pattern tên file theo tiền tố
  const FILE_PATTERNS = (p) => [ d => `${p}BAN${d}.pdf`, d => `${p}QUY${d}.pdf`, d => `${p}XUAT${d}.pdf` ];

  // ===== DOM =====
  const repoSelect = document.getElementById('repoSelect');
  const datePicker = document.getElementById('datePicker');
  const dateHint   = document.getElementById('dateHint');
  const iconsWrap  = document.getElementById('icons');
  const toast      = document.getElementById('toast');
  const prevBtn    = document.getElementById('prevAvail');
  const nextBtn    = document.getElementById('nextAvail');

  // ===== STATE & UTILS =====
  const CACHE = new Map(); // url -> boolean
  let lastRunToken = 0; // để huỷ các lần load cũ nếu user đổi nhanh

  function rawBase(){ return REPOS[repoSelect.value]; }
  function repoNum(){ return REPO_NUM[repoSelect.value] || '1'; }
  function toISODate(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split('T')[0]; }
  function ddmmyyyy(d){ const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); return `${dd}${mm}${yyyy}`; }

  function timeout(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function withTimeout(promiseFactory, ms){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort('timeout'), ms);
    return Promise.race([
      (async ()=>{ try{ return await promiseFactory(ctrl.signal); }catch{return false;} finally{ clearTimeout(t); } })(),
      timeout(ms+50).then(()=>false)
    ]);
  }

  async function checkFileExists(url){
    if(CACHE.has(url)) return CACHE.get(url);
    const ok = await withTimeout(async (signal)=>{
      const r = await fetch(url,{method:'HEAD',signal});
      return r.ok;
    }, 6000);
    CACHE.set(url, !!ok);
    return !!ok;
  }

  async function hasReportByDDMMYYYY(base, dstr){
    const p = repoNum();
    const urls = FILE_PATTERNS(p).map(fn => base + fn(dstr));
    const results = await Promise.all(urls.map(u => checkFileExists(u)));
    return results.some(Boolean);
  }

  function showToast(msg){
    toast.textContent=msg; toast.classList.add('show');
    clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'),2200);
  }

  function createIcon(image, url){
    const div=document.createElement('div'); div.className='pdf-icon';
    const img=document.createElement('img'); img.src=image; img.alt=image; img.loading='lazy';
    div.onclick=()=>{ const fullURL=rawBase()+url; const viewerURL='https://docs.google.com/gview?embedded=true&url='+encodeURIComponent(fullURL); window.open(viewerURL,'_blank'); };
    div.appendChild(img); return div;
  }

  function renderSkeletons(n=3){
    iconsWrap.innerHTML='';
    for(let i=0;i<n;i++){ const s=document.createElement('div'); s.className='skeleton'; iconsWrap.appendChild(s); }
  }

  async function loadPDFIcons(dateValue){
    const runToken = ++lastRunToken;
    renderSkeletons();
    const d = new Date(dateValue);
    const dstr = ddmmyyyy(d);
    const p = repoNum();
    const entries = [
      {img:'nutbanhang.png', file:`${p}BAN${dstr}.pdf`},
      {img:'nutthuchi.png', file:`${p}QUY${dstr}.pdf`},
      {img:'nutxuatkho.png', file:`${p}XUAT${dstr}.pdf`}
    ];

    const checks = await Promise.all(entries.map(e=>checkFileExists(rawBase()+e.file)));
    if(runToken!==lastRunToken) return;

    iconsWrap.innerHTML='';
    let found=0;
    entries.forEach((e,i)=>{ if(checks[i]){ iconsWrap.appendChild(createIcon(e.img,e.file)); found++; } });

    if(found){ dateHint.textContent=`Có ${found} báo cáo cho ngày này.`; }
    else{
      dateHint.textContent='Ngày này KHÔNG có báo cáo.';
      showToast('Ngày này không có báo cáo — tự chuyển sang ngày gần nhất có dữ liệu.');
      await jumpToNearestAvailable(d, runToken);
    }
  }

  async function jumpToNearestAvailable(fromDate, runToken){
    const base = rawBase();
    const limit = 180; // số ngày tối đa để tìm
    for(let i=1;i<=limit;i++){
      if(runToken!==lastRunToken) return;
      const prev = new Date(fromDate); prev.setDate(prev.getDate()-i);
      const next = new Date(fromDate); next.setDate(next.getDate()+i);

      const [hasPrev, hasNext] = await Promise.all([
        hasReportByDDMMYYYY(base, ddmmyyyy(prev)),
        hasReportByDDMMYYYY(base, ddmmyyyy(next))
      ]);

      if(runToken!==lastRunToken) return;
      if(hasPrev){ datePicker.value = toISODate(prev); await loadPDFIcons(datePicker.value); return; }
      if(hasNext){ datePicker.value = toISODate(next); await loadPDFIcons(datePicker.value); return; }
    }
    showToast('Không tìm thấy ngày có báo cáo trong phạm vi tìm.');
  }

  // Tìm theo hướng (liền trước / liền sau)
  async function jumpDirectional(fromDate, step){
    const base = rawBase();
    const limit = 365;
    prevBtn.disabled = true; nextBtn.disabled = true;
    try{
      for(let i=1;i<=limit;i++){
        const cand = new Date(fromDate); cand.setDate(cand.getDate()+step*i);
        if(await hasReportByDDMMYYYY(base, ddmmyyyy(cand))){
          datePicker.value = toISODate(cand);
          await loadPDFIcons(datePicker.value);
          showToast(step<0 ? 'Đã nhảy tới ngày có file liền trước.' : 'Đã nhảy tới ngày có file liền sau.');
          return;
        }
      }
      showToast('Không thấy ngày phù hợp theo hướng đã chọn.');
    } finally {
      prevBtn.disabled = false; nextBtn.disabled = false;
    }
  }

  // ===== EVENTS =====
  repoSelect.addEventListener('change', ()=>{
    localStorage.setItem('sbm_repo', repoSelect.value);
    loadPDFIcons(datePicker.value);
  });

  datePicker.addEventListener('change', ()=>{ loadPDFIcons(datePicker.value); });
  prevBtn.addEventListener('click', ()=> jumpDirectional(new Date(datePicker.value), -1));
  nextBtn.addEventListener('click', ()=> jumpDirectional(new Date(datePicker.value),  1));

  // ===== INIT =====
  (function init(){
    const savedRepo = localStorage.getItem('sbm_repo') || 'SBM1';
    repoSelect.value = savedRepo;

    const today = new Date();
    const todayStr = toISODate(today);
    datePicker.value=todayStr; datePicker.max=todayStr;

    loadPDFIcons(todayStr);
  })();

  // ===== OFFLINE HANDLING =====
  window.addEventListener('offline', ()=> showToast('Mất kết nối mạng. Một số báo cáo sẽ không tải được.'));
  window.addEventListener('online',  ()=> showToast('Đã khôi phục mạng.'));

  // ===== LIGHT TESTS (console) =====
  (function tests(){
    try{
      console.groupCollapsed('Self-tests');
      const t = new Date('2025-10-05T00:00:00');
      console.assert(ddmmyyyy(t)==='05102025','ddmmyyyy failed');

      const dstr='01012025';
      console.assert(FILE_PATTERNS('1')[0](dstr)==='1BAN01012025.pdf','pattern 1BAN');
      console.assert(FILE_PATTERNS('2')[1](dstr)==='2QUY01012025.pdf','pattern 2QUY');
      console.assert(FILE_PATTERNS('3')[2](dstr)==='3XUAT01012025.pdf','pattern 3XUAT');

      console.log('All tests passed ✅');
      console.groupEnd();
    }catch(e){ console.error('Self-tests error', e); }
  })();
</script>
</body>
</html>
