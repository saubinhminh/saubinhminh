<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>BÁO CÁO TỔNG HỢP — SBM3 ONLY</title>
  <style>
    :root{ --accent:#ff4d4f; --bg:rgba(0,0,0,.5); --card:rgba(255,255,255,.08); --text:#fff; --shadow:0 6px 20px rgba(0,0,0,.35); --active:rgba(255,255,255,.18); }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{font-family:system-ui,Arial,sans-serif;margin:0;color:var(--text);background:#0a0a0a url('NenVuTru.png') no-repeat center center fixed;background-size:cover;display:flex;flex-direction:column}

    .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(0deg,rgba(0,0,0,.2),rgba(0,0,0,.7));backdrop-filter:blur(8px);padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .brand{display:flex;align-items:center;justify-content:center}
    .brand h1{font-size:18px;margin:0;text-shadow:1px 1px 2px #000}

    .seg{display:flex;gap:8px;margin-top:8px}
    .seg .tab{flex:1;text-align:center;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:var(--text);cursor:pointer;user-select:none}
    .seg .tab.active{background:var(--active);box-shadow:var(--shadow)}
    .seg .tab:focus{outline:2px solid var(--accent)}

    .controls{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
    .control{background:var(--bg);border-radius:14px;padding:10px;box-shadow:var(--shadow)}
    label{font-size:12px;opacity:.9;display:block;margin-bottom:4px}
    select,input[type="date"],button.btn{width:100%;font-size:16px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:var(--text)}
    button.btn{cursor:pointer}
    button.btn[disabled]{opacity:.6;cursor:not-allowed}

    #pdfContainer{padding:8px 12px 20px}
    .icons{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .pdf-icon{width:100%;cursor:pointer;transition:transform .15s ease}
    .pdf-icon:active{transform:scale(.97)}
    .pdf-icon img{width:100%;height:auto;border-radius:16px;box-shadow:var(--shadow)}

    .skeleton{position:relative;overflow:hidden;border-radius:16px;height:70px;background:rgba(255,255,255,.08)}
    .skeleton:after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);animation:shimmer 1.3s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    .hint{font-size:13px;opacity:.95;margin-top:6px}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);font-size:14px;z-index:9999;opacity:0;pointer-events:none;transition:opacity .25s ease}
    .toast.show{opacity:1}

    .adjacent{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    @media (max-width:460px){ .icons{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><h1>BÁO CÁO TỔNG HỢP</h1></div>

    <div class="seg" id="modeSeg" role="tablist" aria-label="Chế độ hiển thị">
      <div class="tab active" data-mode="sosach" role="tab" tabindex="0" aria-selected="true">SỔ SÁCH</div>
      <div class="tab" data-mode="kinhdoanh" role="tab" tabindex="-1" aria-selected="false">KINH DOANH</div>
    </div>

    <div class="controls">
      <div class="control" id="dateGroup">
        <label id="dateLabel" for="datePicker">Chọn ngày</label>
        <input type="date" id="datePicker" />
        <div class="hint" id="dateHint">&nbsp;</div>

        <!-- Nút tìm ngày có file liền kề (chỉ dùng ở SỔ SÁCH) -->
        <div class="adjacent" id="adjacentBtns">
          <button class="btn" id="prevAvail">◀️ Ngày trước (có file)</button>
          <button class="btn" id="nextAvail">Ngày sau (có file) ▶️</button>
        </div>

        <!-- Cụm KINH DOANH -->
        <div id="bizInline" style="display:none">
          <label for="yearSelect">Chọn năm</label>
          <select id="yearSelect"></select>
          <div class="hint" id="yearHint">&nbsp;</div>
          <button class="btn" id="openBizInline">MỞ BÁO CÁO KINH DOANH</button>
        </div>
      </div>
    </div>
  </div>

  <div id="pdfContainer">
    <div class="icons" id="icons"></div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
  // ===== BASE (SBM3 ONLY) =====
  const BASE = 'https://raw.githubusercontent.com/saubinhminh/3ILIILIIXIILI/main/'; // SBM3

  // ===== DOM =====
  const modeSeg = document.getElementById('modeSeg');
  const dateLabel = document.getElementById('dateLabel');
  const datePicker = document.getElementById('datePicker');
  const dateHint = document.getElementById('dateHint');
  const iconsWrap = document.getElementById('icons');
  const toast = document.getElementById('toast');
  const bizInline = document.getElementById('bizInline');
  const yearSelect = document.getElementById('yearSelect');
  const yearHint = document.getElementById('yearHint');
  const openBizInline = document.getElementById('openBizInline');
  const adjacentBtns = document.getElementById('adjacentBtns');
  const prevBtn = document.getElementById('prevAvail');
  const nextBtn = document.getElementById('nextAvail');

  // ===== UTILS =====
  const CACHE = new Map();
  let lastRunToken = 0;
  const rawBase = ()=> BASE;
  const toISODate = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split('T')[0];
  const ddmmyyyy = d => `${String(d.getDate()).padStart(2,'0')}${String(d.getMonth()+1).padStart(2,'0')}${d.getFullYear()}`;
  const getBizFile = year => `3BAO${year}.pdf`; // SBM3

  const timeout = ms => new Promise(r=>setTimeout(r,ms));
  function withTimeout(promiseFactory, ms){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort('timeout'), ms);
    return Promise.race([
      (async ()=>{ try{ return await promiseFactory(ctrl.signal); }catch{return false;} finally{ clearTimeout(t); } })(),
      timeout(ms+50).then(()=>false)
    ]);
  }

  async function checkFileExists(url){
    if(CACHE.has(url)) return CACHE.get(url);
    const ok = await withTimeout(async (signal)=>{
      const r = await fetch(url,{method:'HEAD',signal});
      return r.ok;
    }, 6000);
    CACHE.set(url, !!ok);
    return !!ok;
  }

  // SỔ SÁCH của SBM3: dùng 3BAN/3QUY/3XUAT
  async function hasReportByDDMMYYYY(base, dstr){
    const urls = [
      base + `3BAN${dstr}.pdf`,
      base + `3QUY${dstr}.pdf`,
      base + `3XUAT${dstr}.pdf`
    ];
    const results = await Promise.all(urls.map(u => checkFileExists(u)));
    return results.some(Boolean);
  }

  function showToast(msg){
    toast.textContent=msg; toast.classList.add('show');
    clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'),2200);
  }

  function createIcon(image, url){
    const div=document.createElement('div'); div.className='pdf-icon';
    const img=document.createElement('img'); img.src=image; img.alt=image; img.loading='lazy';
    div.onclick=()=>{ const fullURL=rawBase()+url; const viewerURL='https://docs.google.com/gview?embedded=true&url='+encodeURIComponent(fullURL); window.open(viewerURL,'_blank'); };
    div.appendChild(img); return div;
  }

  function renderSkeletons(n=3){
    iconsWrap.innerHTML='';
    for(let i=0;i<n;i++){ const s=document.createElement('div'); s.className='skeleton'; iconsWrap.appendChild(s); }
  }

  async function loadPDFIcons(dateValue){
    const runToken = ++lastRunToken;
    renderSkeletons();
    const d = new Date(dateValue);
    const dstr = ddmmyyyy(d);

    const entries = [
      {img:'nutbanhang.png', file:`3BAN${dstr}.pdf`},
      {img:'nutthuchi.png', file:`3QUY${dstr}.pdf`},
      {img:'nutxuatkho.png', file:`3XUAT${dstr}.pdf`}
    ];

    const checks = await Promise.all(entries.map(e=>checkFileExists(rawBase()+e.file)));
    if(runToken!==lastRunToken) return;

    iconsWrap.innerHTML='';
    let found=0;
    entries.forEach((e,i)=>{ if(checks[i]){ iconsWrap.appendChild(createIcon(e.img,e.file)); found++; } });

    if(found){ dateHint.textContent=`Có ${found} báo cáo cho ngày này.`; }
    else{
      dateHint.textContent='Ngày này KHÔNG có báo cáo.';
      showToast('Ngày này không có báo cáo — tự chuyển sang ngày gần nhất có dữ liệu.');
      await jumpToNearestAvailable(d, runToken);
    }
  }

  async function jumpToNearestAvailable(fromDate, runToken){
    const base = rawBase();
    const limit = 180;
    for(let i=1;i<=limit;i++){
      if(runToken!==lastRunToken) return;
      const prev = new Date(fromDate); prev.setDate(prev.getDate()-i);
      const next = new Date(fromDate); next.setDate(next.getDate()+i);

      const [hasPrev, hasNext] = await Promise.all([
        hasReportByDDMMYYYY(base, ddmmyyyy(prev)),
        hasReportByDDMMYYYY(base, ddmmyyyy(next))
      ]);

      if(runToken!==lastRunToken) return;
      if(hasPrev){ datePicker.value = toISODate(prev); await loadPDFIcons(datePicker.value); return; }
      if(hasNext){ datePicker.value = toISODate(next); await loadPDFIcons(datePicker.value); return; }
    }
    showToast('Không tìm thấy ngày có báo cáo trong phạm vi tìm.');
  }

  // Tìm theo hướng (liền trước / liền sau)
  async function jumpDirectional(fromDate, step){
    const base = rawBase();
    const limit = 365;
    prevBtn.disabled = true; nextBtn.disabled = true;
    try{
      for(let i=1;i<=limit;i++){
        const cand = new Date(fromDate); cand.setDate(cand.getDate()+step*i);
        if(await hasReportByDDMMYYYY(base, ddmmyyyy(cand))){
          datePicker.value = toISODate(cand);
          await loadPDFIcons(datePicker.value);
          showToast(step<0 ? 'Đã nhảy tới ngày có file liền trước.' : 'Đã nhảy tới ngày có file liền sau.');
          return;
        }
      }
      showToast('Không thấy ngày phù hợp theo hướng đã chọn.');
    } finally {
      prevBtn.disabled = false; nextBtn.disabled = false;
    }
  }

  // ===== EVENTS =====
  modeSeg.addEventListener('click', e=>{
    const tab=e.target.closest('.tab'); if(!tab) return;
    document.querySelectorAll('.seg .tab').forEach(t=>{ t.classList.remove('active'); t.setAttribute('aria-selected','false'); t.tabIndex=-1; });
    tab.classList.add('active'); tab.setAttribute('aria-selected','true'); tab.tabIndex=0; tab.focus();
    const isBiz = tab.dataset.mode==='kinhdoanh';
    // toggle vùng hiển thị
    dateLabel.style.display = isBiz? 'none' : '';
    datePicker.style.display = isBiz? 'none' : '';
    dateHint.style.display   = isBiz? 'none' : '';
    adjacentBtns.style.display = isBiz? 'none' : 'grid';
    bizInline.style.display  = isBiz? 'block': 'none';
    iconsWrap.style.display  = isBiz? 'none' : 'grid';
    if(isBiz) updateBizButtonState();
  });

  modeSeg.addEventListener('keydown', (e)=>{
    if(e.key!=='ArrowRight' && e.key!=='ArrowLeft') return;
    const tabs=[...document.querySelectorAll('.seg .tab')];
    const idx=tabs.findIndex(t=>t.classList.contains('active'));
    const next = e.key==='ArrowRight' ? (idx+1)%tabs.length : (idx-1+tabs.length)%tabs.length;
    tabs[next].click();
  });

  const updateBizButtonState = async ()=>{
    openBizInline.disabled = true;
    const year = yearSelect.value;
    const file = getBizFile(year);
    const url = rawBase()+file;
    const ok = await checkFileExists(url);
    openBizInline.disabled = !ok;
    yearHint.textContent = ok ? `Tìm thấy 1 file báo cáo` : `Không tìm thấy file báo cáo`;
  };

  openBizInline.addEventListener('click', async ()=>{
    const year = yearSelect.value;
    const file = getBizFile(year);
    const url = rawBase()+file;
    if(!(await checkFileExists(url))){ showToast('Chưa có BÁO CÁO KINH DOANH cho năm này.'); return; }
    const viewerURL='https://docs.google.com/gview?embedded=true&url='+encodeURIComponent(url);
    window.open(viewerURL,'_blank');
  });

  datePicker.addEventListener('change', ()=>{ loadPDFIcons(datePicker.value); });
  yearSelect.addEventListener('change', ()=>{ updateBizButtonState(); });
  prevBtn.addEventListener('click', ()=> jumpDirectional(new Date(datePicker.value), -1));
  nextBtn.addEventListener('click', ()=> jumpDirectional(new Date(datePicker.value),  1));

  // ===== INIT =====
  (function init(){
    const today = new Date();
    const todayStr = toISODate(today);
    datePicker.value=todayStr; datePicker.max=todayStr;

    // populate year options (8 năm: năm hiện tại+1 xuống hiện tại-6)
    const curYear = new Date().getFullYear();
    const start = curYear - 6; const end = curYear + 1;
    yearSelect.innerHTML = '';
    for(let y=end; y>=start; y--){
      const opt = document.createElement('option'); opt.value=String(y); opt.textContent=String(y);
      yearSelect.appendChild(opt);
    }
    yearSelect.value = String(curYear);

    loadPDFIcons(todayStr);
  })();

  // ===== OFFLINE HANDLING =====
  window.addEventListener('offline', ()=> showToast('Mất kết nối mạng. Một số báo cáo sẽ không tải được.'));
  window.addEventListener('online',  ()=> showToast('Đã khôi phục mạng.'));

  // ===== LIGHT TESTS (console) =====
  (function tests(){
    try{
      console.groupCollapsed('Self-tests');
      console.assert(getBizFile('2025')==='3BAO2025.pdf','SBM3 mapping failed');

      const t = new Date('2025-10-05T00:00:00');
      console.assert(ddmmyyyy(t)==='05102025','ddmmyyyy failed');

      // test tên file SỔ SÁCH dùng 3*
      const dstr='01012025';
      console.assert(`3BAN${dstr}.pdf`==='3BAN01012025.pdf','3BAN pattern');
      console.assert(`3QUY${dstr}.pdf`==='3QUY01012025.pdf','3QUY pattern');
      console.assert(`3XUAT${dstr}.pdf`==='3XUAT01012025.pdf','3XUAT pattern');

      console.log('All tests passed ✅');
      console.groupEnd();
    }catch(e){ console.error('Self-tests error', e); }
  })();
</script>
</body>
</html>
